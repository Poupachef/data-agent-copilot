<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WhatsApp Web Clone</title>
    <link rel="stylesheet" href="/static/styles.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script>
        // Define fun√ß√£o placeholder IMEDIATAMENTE para garantir que esteja dispon√≠vel
        window.startMockMode = function() {
            console.log('üîÑ startMockMode chamado (aguardando m√≥dulos)...');
            
            // Se a vers√£o completa j√° est√° dispon√≠vel, usa ela
            if (window._startMockModeReady) {
                console.log('‚úÖ Vers√£o completa dispon√≠vel, executando...');
                return window._startMockModeReady();
            }
            
            // Caso contr√°rio, aguarda os m√≥dulos carregarem
            let attempts = 0;
            const maxAttempts = 100; // 20 segundos
            
            function tryStart() {
                attempts++;
                
                // Verifica se os m√≥dulos est√£o dispon√≠veis
                const mockAvailable = typeof window.Mock !== 'undefined';
                const uiAvailable = typeof window.UI !== 'undefined';
                
                if (attempts === 1 || attempts % 10 === 0) {
                    console.log('Verificando m√≥dulos (tentativa ' + attempts + '):');
                    console.log('  Mock:', mockAvailable);
                    console.log('  UI:', uiAvailable);
                    console.log('  _startMockModeReady:', typeof window._startMockModeReady !== 'undefined');
                }
                
                // Se a vers√£o completa est√° dispon√≠vel, usa ela
                if (window._startMockModeReady) {
                    console.log('‚úÖ Vers√£o completa dispon√≠vel agora, executando...');
                    return window._startMockModeReady();
                }
                
                // Se Mock est√° dispon√≠vel, executa mesmo sem UI (UI √© opcional)
                if (mockAvailable) {
                    console.log('‚úÖ Mock dispon√≠vel, executando modo mockado...');
                    if (!uiAvailable) {
                        console.warn('‚ö†Ô∏è UI n√£o dispon√≠vel, usando fallback direto');
                    }
                    try {
                        const mock = window.Mock;
                        const ui = window.UI; // Pode ser undefined
                        
                        if (mock && mock.enableMockMode) {
                            mock.enableMockMode();
                            console.log('‚úÖ Modo mockado ativado');
                        }
                        
                        // Mostra notifica√ß√£o se UI estiver dispon√≠vel
                        if (ui && ui.notify) {
                            ui.notify('Modo mockado ativado!', 'success');
                        } else {
                            console.log('‚úÖ Modo mockado ativado (sem notifica√ß√£o UI)');
                        }
                        
                        // Mostra chat - tenta UI primeiro, sen√£o usa fallback direto
                        if (ui && ui.showChat) {
                            ui.showChat();
                        } else {
                            const loginScreenEl = document.getElementById('login-screen');
                            const chatInterfaceEl = document.getElementById('chat-interface');
                            if (loginScreenEl) {
                                loginScreenEl.style.display = 'none';
                                console.log('‚úÖ Tela de login ocultada');
                            }
                            if (chatInterfaceEl) {
                                chatInterfaceEl.style.display = 'flex';
                                console.log('‚úÖ Interface de chat exibida');
                            }
                        }
                        
                        // Carrega chats
                        setTimeout(() => {
                            console.log('üîÑ Tentando carregar chats...');
                            console.log('  window.loadChats:', typeof window.loadChats);
                            console.log('  mock.getChats:', typeof mock.getChats);
                            
                            // Tenta carregar diretamente do Mock primeiro (mais confi√°vel)
                            if (mock.getChats) {
                                console.log('‚úÖ Carregando chats diretamente do Mock...');
                                loadChatsFromMock(mock);
                            } else if (typeof window.loadChats === 'function') {
                                console.log('‚úÖ Carregando chats via loadChats...');
                                try {
                                    const result = window.loadChats();
                                    // Se retornar uma Promise, aguarda
                                    if (result && typeof result.then === 'function') {
                                        result.catch(err => {
                                            console.error('‚ùå Erro ao carregar chats (Promise):', err);
                                            console.error('Stack:', err.stack);
                                        });
                                    }
                                } catch (err) {
                                    console.error('‚ùå Erro ao chamar loadChats:', err);
                                    console.error('Stack:', err.stack);
                                    // Fallback para mock.getChats
                                    if (mock.getChats) {
                                        loadChatsFromMock(mock);
                                    }
                                }
                            } else {
                                console.error('‚ùå Nenhum m√©todo dispon√≠vel para carregar chats');
                            }
                        }, 300);
                        
                        // Fun√ß√£o auxiliar para carregar chats do Mock
                        function loadChatsFromMock(mock) {
                            console.log('üîÑ loadChatsFromMock chamado...');
                            console.log('  mock:', mock);
                            console.log('  mock.getChats:', typeof mock.getChats);
                            
                            try {
                                if (!mock || !mock.getChats) {
                                    throw new Error('mock.getChats n√£o est√° dispon√≠vel');
                                }
                                
                                const result = mock.getChats();
                                console.log('‚úÖ Resultado de getChats:', result);
                                console.log('  √â Promise?', result && typeof result.then === 'function');
                                
                                // Se retornar uma Promise, aguarda
                                if (result && typeof result.then === 'function') {
                                    result.then(chats => {
                                        console.log('‚úÖ Chats recebidos (Promise):', chats ? chats.length : 0);
                                        console.log('  Chats:', chats);
                                        if (chats && chats.length > 0) {
                                            renderChats(chats);
                                        } else {
                                            console.warn('‚ö†Ô∏è Nenhum chat recebido da Promise');
                                        }
                                    }).catch(err => {
                                        console.error('‚ùå Erro ao carregar chats (Promise):', err);
                                        console.error('Stack:', err.stack);
                                    });
                                } else {
                                    // Se retornar diretamente
                                    console.log('‚úÖ Chats recebidos (direto):', result ? result.length : 0);
                                    console.log('  Chats:', result);
                                    if (result && result.length > 0) {
                                        renderChats(result);
                                    } else {
                                        console.warn('‚ö†Ô∏è Nenhum chat recebido diretamente');
                                    }
                                }
                            } catch (err) {
                                console.error('‚ùå Erro ao chamar mock.getChats:', err);
                                console.error('Stack:', err.stack);
                            }
                        }
                        
                        // Fun√ß√£o auxiliar para renderizar chats
                        function renderChats(chats) {
                            console.log('üîÑ renderChats chamado com:', chats);
                            const chatListEl = document.getElementById('chat-list');
                            if (!chatListEl) {
                                console.error('‚ùå chat-list n√£o encontrado!');
                                // Tenta novamente ap√≥s um delay
                                setTimeout(() => {
                                    const retryEl = document.getElementById('chat-list');
                                    if (retryEl) {
                                        renderChats(chats);
                                    } else {
                                        console.error('‚ùå chat-list ainda n√£o encontrado ap√≥s retry');
                                    }
                                }, 100);
                                return;
                            }
                            
                            if (!chats || chats.length === 0) {
                                console.warn('‚ö†Ô∏è Nenhum chat recebido');
                                chatListEl.innerHTML = '<div style="padding: 20px; text-align: center; color: #999;">Nenhuma conversa dispon√≠vel</div>';
                                return;
                            }
                            
                            try {
                                // Sempre usa fallback para garantir que funcione
                                console.log('‚úÖ Renderizando', chats.length, 'chats com fallback...');
                                
                                // Limpa o conte√∫do anterior
                                chatListEl.innerHTML = '';
                                
                                // Cria cada chat item
                                chats.forEach((chat, index) => {
                                    try {
                                        const chatId = chat.id && chat.id._serialized ? chat.id._serialized : (chat.id || `chat-${index}`);
                                        const name = chat.name || (typeof chatId === 'string' ? chatId.split('@')[0] : 'Desconhecido');
                                        const lastMsg = chat.lastMessage || {};
                                        const lastMsgText = (lastMsg.body || '').substring(0, 50);
                                        const lastMsgTime = lastMsg.timestamp
                                            ? new Date(lastMsg.timestamp * 1000).toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' })
                                            : '';
                                        const unread = chat.unreadCount > 0
                                            ? `<span class="unread-badge">${chat.unreadCount}</span>`
                                            : '';
                                        
                                        // Cria o elemento
                                        const chatItem = document.createElement('div');
                                        chatItem.className = 'chat-item';
                                        chatItem.setAttribute('data-chat-id', chatId);
                                        
                                        // Adiciona event listener ao inv√©s de onclick inline
                                        chatItem.addEventListener('click', function(e) {
                                            e.stopPropagation();
                                            if (typeof window.selectChat === 'function') {
                                                window.selectChat(chatId);
                                            } else {
                                                console.error('selectChat n√£o dispon√≠vel');
                                            }
                                            return false;
                                        });
                                        
                                        chatItem.innerHTML = `
                                            <div class="chat-avatar">
                                                <div class="avatar-placeholder">üë§</div>
                                            </div>
                                            <div class="chat-info">
                                                <div class="chat-header">
                                                    <div class="chat-name">${name}</div>
                                                    <div class="chat-time">${lastMsgTime}</div>
                                                </div>
                                                <div class="chat-preview">
                                                    <div class="chat-message">${lastMsgText}</div>
                                                    ${unread}
                                                </div>
                                            </div>
                                        `;
                                        
                                        chatListEl.appendChild(chatItem);
                                    } catch (chatErr) {
                                        console.error(`‚ùå Erro ao renderizar chat ${index}:`, chatErr);
                                    }
                                });
                                
                                console.log('‚úÖ Lista de chats renderizada com sucesso! Total:', chats.length);
                            } catch (err) {
                                console.error('‚ùå Erro ao renderizar chats:', err);
                                console.error('Stack:', err.stack);
                                chatListEl.innerHTML = '<div style="padding: 20px; text-align: center; color: #e74c3c;">Erro ao carregar conversas</div>';
                            }
                        }
                    } catch (err) {
                        console.error('‚ùå Erro ao executar modo mockado:', err);
                        console.error('Stack:', err.stack);
                        alert('Erro: ' + err.message);
                    }
                    return;
                }
                
                // Se ainda n√£o carregou, aguarda mais
                if (attempts < maxAttempts) {
                    if (attempts % 10 === 0) {
                        console.log('‚è≥ Aguardando m√≥dulos carregarem... (tentativa ' + attempts + '/' + maxAttempts + ')');
                    }
                    setTimeout(tryStart, 200);
                } else {
                    console.error('‚ùå Timeout: m√≥dulos n√£o carregaram ap√≥s 20 segundos');
                    alert('Erro: m√≥dulos n√£o carregaram. Recarregue a p√°gina.');
                }
            }
            
            tryStart();
        };
        console.log('‚úÖ window.startMockMode definida no <head>');
    </script>
</head>
<body>
    <!-- Login Screen -->
    <div id="login-screen" class="login-screen">
        <div class="login-container">
            <div class="login-header">
                <div class="whatsapp-logo">
                    <i class="fab fa-whatsapp"></i>
                    <span>WhatsApp</span>
                </div>
            </div>
            
            <div class="login-card">
                <div class="login-content">
                    <h2>Conectar ao WhatsApp</h2>
                    
                    <div class="phone-input-container">
                        <input type="text" id="main-phone-input" placeholder="Digite seu n√∫mero de telefone (ex: 5511999999999)" class="phone-input" required>
                    </div>
                    
                    <!-- Bot√£o para modo mockado -->
                    <div id="mock-start-container" style="margin: 20px 0; padding: 15px; background: #e3f2fd; border-radius: 8px; border: 1px solid #90caf9;">
                        <p style="margin: 0 0 10px 0; color: #1976d2; font-size: 14px;">
                            <i class="fas fa-flask" style="margin-right: 8px;"></i>
                            <strong>Modo de Teste:</strong> Teste a interface sem conectar ao WhatsApp
                        </p>
                        <button id="start-mock-btn" class="btn btn-primary" style="width: 100%; cursor: pointer;" type="button" onclick="console.log('üñ±Ô∏è CLIQUE NO BOT√ÉO!'); if (typeof window.startMockMode === 'function') { window.startMockMode(); } else { console.error('startMockMode n√£o encontrada!'); alert('Fun√ß√£o n√£o encontrada. Recarregue a p√°gina.'); }">
                            <i class="fas fa-play-circle"></i>
                            Iniciar Chat Mockado
                        </button>
                    </div>
                    <!-- Session Management -->
                    <div id="session-management" class="session-management" style="margin: 20px 0; padding: 15px; background: #f8f9fa; border-radius: 8px; border: 1px solid #e9ecef;">
                        <h4 style="margin: 0 0 15px 0; color: #333; display: flex; align-items: center;">
                            <i class="fas fa-cogs" style="margin-right: 8px;"></i>
                            Gerenciamento de Sess√£o
                        </h4>
                        
                        <div class="session-actions" style="display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 15px;">
                            <button id="create-session-btn" class="btn btn-success" style="flex: 1; min-width: 120px;">
                                <i class="fas fa-plus"></i>
                                Criar Sess√£o
                            </button>
                            <button id="delete-session-btn" class="btn btn-danger" style="flex: 1; min-width: 120px;">
                                <i class="fas fa-trash"></i>
                                Deletar Sess√£o
                            </button>
                            <button id="refresh-session-btn" class="btn btn-info" style="flex: 1; min-width: 120px;">
                                <i class="fas fa-sync-alt"></i>
                                Atualizar
                            </button>
                        </div>
                        
                        <div id="session-status" class="session-status" style="font-size: 14px; color: #666;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">
                                <span>Status da Sess√£o:</span>
                                <span id="current-session-status" style="font-weight: bold; color: #333;">Verificando...</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <span>Sess√£o Ativa:</span>
                                <span id="active-session-name" style="font-weight: bold; color: #333;">-</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Session Status and Controls -->
                    <div id="session-controls" class="session-controls" style="display: none; margin: 15px 0; padding: 15px; background: #f5f5f5; border-radius: 8px; border: 1px solid #ddd;">
                        <h4 style="margin: 0 0 10px 0; color: #333;">Status da Sess√£o</h4>
                        
                        <div id="session-info" class="session-info" style="margin-bottom: 15px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                <span style="font-weight: bold;">Status:</span>
                                <span id="session-state" style="padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: bold;">Desconhecido</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                <span style="font-weight: bold;">Usu√°rio:</span>
                                <span id="session-user" style="font-size: 14px;">-</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <span style="font-weight: bold;">Engine:</span>
                                <span id="session-engine" style="font-size: 14px;">-</span>
                            </div>
                        </div>
                        
                        <div class="session-actions" style="display: flex; gap: 10px; flex-wrap: wrap;">
                            <button id="start-session-btn" class="btn btn-success" style="flex: 1; min-width: 100px;">
                                <i class="fas fa-play"></i>
                                Start
                            </button>
                            <button id="stop-session-btn" class="btn btn-warning" style="flex: 1; min-width: 100px;">
                                <i class="fas fa-stop"></i>
                                Stop
                            </button>
                            <button id="generate-qr-btn" class="btn btn-primary" style="flex: 1; min-width: 100px;">
                                <i class="fas fa-qrcode"></i>
                                QR Code
                            </button>
                            <button id="show-chat-btn" class="btn btn-info" style="flex: 1; min-width: 100px;">
                                <i class="fas fa-comments"></i>
                                Chat
                            </button>
                        </div>
                    </div>
                    

                    
                    <div id="qr-container" class="qr-container">
                        <div id="qr-code" class="qr-code">
                            <!-- QR Code will be inserted here -->
                        </div>
                        <div id="qr-loading" class="qr-loading">
                            <div class="spinner"></div>
                        </div>
                    </div>
                    

                    

                    
                    <div id="code-input-container" class="code-input-container" style="display: none;">
                        <button id="submit-code-btn" class="btn btn-primary">Entrar</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Chat Interface -->
    <div id="chat-interface" class="chat-interface" style="display: none;">
        <!-- Header -->
        <div class="chat-header">
            <div class="header-left">
                <div class="user-avatar">
                    <img id="user-avatar" src="https://via.placeholder.com/40" alt="Avatar">
                </div>
                <div class="user-info">
                    <h3 id="user-name">WhatsApp Web</h3>
                    <span id="connection-status" class="status-text">Conectado</span>
                </div>
            </div>
            <div class="header-right">
                <div id="debug-area" class="debug-area" style="margin-right: 20px;">
                    <div id="ws-status" class="ws-status">üî¥ WebSocket</div>
                    <div id="event-counter" class="event-counter">0 eventos</div>
                    <div id="last-event" class="last-event">Aguardando...</div>
                </div>
                <button id="logout-btn" class="header-btn" title="Sair">
                    <i class="fas fa-sign-out-alt"></i>
                </button>
            </div>
        </div>

        <!-- Main Content -->
        <div class="chat-main">
            <!-- Left Navigation Bar -->
            <div class="left-nav">
                <div class="nav-header">
                    <div class="user-avatar">
                        <img src="https://via.placeholder.com/40" alt="Avatar" id="user-avatar">
                    </div>
                </div>
                <div class="nav-buttons">
                    <button id="chats-btn" class="nav-btn active" title="Conversas">
                        <i class="fas fa-comment"></i>
                    </button>
                    <button id="contacts-btn" class="nav-btn" title="Contatos">
                        <i class="fas fa-address-book"></i>
                    </button>
                    <button class="nav-btn" title="Status">
                        <i class="fas fa-circle-notch"></i>
                    </button>
                    <button class="nav-btn" title="Canais">
                        <i class="fas fa-bullhorn"></i>
                    </button>
                    <button id="session-settings-btn" class="nav-btn" title="Configura√ß√µes da Sess√£o">
                        <i class="fas fa-cog"></i>
                    </button>
                </div>
            </div>
            
            <!-- Sidebar -->
            <div class="chat-sidebar">
                <div class="sidebar-header">
                    <h2 id="sidebar-title">Conversas</h2>
                    <div class="sidebar-actions">
                        <button id="sync-chats-btn" class="sidebar-btn" title="Sincronizar chats">
                            <i class="fas fa-sync-alt"></i>
                        </button>
                        <button class="sidebar-btn" title="Nova conversa">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="sidebar-btn" title="Menu">
                            <i class="fas fa-ellipsis-v"></i>
                        </button>
                    </div>
                </div>
                
                <div class="search-container">
                    <div class="search-box">
                        <i class="fas fa-search"></i>
                        <input type="text" id="search-input" placeholder="Pesquisar ou come√ßar uma nova conversa">
                    </div>
                </div>
                
                <div class="chat-list" id="chat-list">
                    <!-- Chat items will be inserted here -->
                </div>
            </div>

            <!-- Chat Area -->
            <div class="chat-area">
                <div id="no-chat-selected" class="no-chat-selected">
                    <div class="welcome-message">
                        <i class="fab fa-whatsapp"></i>
                        <h2>WhatsApp Web</h2>
                        <p>Envie e receba mensagens sem precisar conectar seu telefone.</p>
                        <p>Selecione uma conversa para come√ßar a mensagem.</p>
                    </div>
                </div>

                <div id="chat-messages" class="chat-messages" style="display: none;">
                    <!-- Chat messages will be inserted here -->
                </div>

                <div id="message-input-container" class="message-input-container" style="display: none;">
                    <div class="input-actions">
                        <button class="input-btn" title="Anexar">
                            <i class="fas fa-paperclip"></i>
                        </button>
                    </div>
                    <div class="message-input-wrapper">
                        <input type="text" id="message-input" placeholder="Digite uma mensagem" class="message-input">
                    </div>
                    <div class="input-actions">
                        <button class="input-btn" title="Emoji">
                            <i class="far fa-smile"></i>
                        </button>
                        <button id="send-btn" class="input-btn send-btn" title="Enviar">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Templates -->
    <template id="chat-item-template">
        <div class="chat-item" data-jid="">
            <div class="chat-avatar">
                <img src="https://via.placeholder.com/50" alt="Avatar">
            </div>
            <div class="chat-info">
                <div class="chat-header">
                    <h4 class="chat-name"></h4>
                    <span class="chat-time"></span>
                </div>
                <div class="chat-preview">
                    <p class="chat-message"></p>
                    <div class="chat-meta">
                        <span class="unread-count" style="display: none;"></span>
                    </div>
                </div>
            </div>
        </div>
    </template>

    <template id="message-template">
        <div class="message" data-message-id="">
            <div class="message-content">
                <div class="message-text"></div>
                <div class="message-time"></div>
            </div>
        </div>
    </template>

    <script src="/static/api.js?v=3.0"></script>
    <script src="/static/websocket.js?v=3.0"></script>
    <script src="/static/session.js?v=3.0"></script>
    <script src="/static/mock.js?v=3.0"></script>
    <script src="/static/ui.js?v=3.0"></script>
    <script src="/static/chat.js?v=3.0"></script>
    <script src="/static/app.js?v=3.0"></script>
    <script>
        // Aguarda todos os scripts carregarem e ent√£o verifica se os m√≥dulos est√£o dispon√≠veis
        window.addEventListener('DOMContentLoaded', function() {
            console.log('DOM carregado, verificando m√≥dulos...');
            console.log('Mock:', typeof window.Mock);
            console.log('UI:', typeof window.UI);
            console.log('Chat:', typeof window.Chat);
            
            // Se startMockMode foi chamada antes dos m√≥dulos carregarem, tenta novamente
            if (window._pendingMockModeStart) {
                console.log('Tentando iniciar modo mockado novamente...');
                setTimeout(() => {
                    if (window.startMockMode) {
                        window.startMockMode();
                    }
                }, 100);
            }
        });
    </script>
</body>
</html> 